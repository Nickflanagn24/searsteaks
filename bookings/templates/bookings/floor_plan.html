{% extends 'bookings/base.html' %}
{% load static %}

{% block content %}
<div class="container mt-4">
    <h2 class="text-center">Restaurant Table Booking</h2>
    
    <div class="row mb-3">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h4 class="mb-0">Select Date & Time</h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-5">
                            <label for="date">Date:</label>
                            <input type="date" id="date" class="form-control" value="{{ today }}">
                        </div>
                        <div class="col-md-5">
                            <label for="time">Time:</label>
                            <select id="time" class="form-control">
                                <option value="18:30">6:30 PM</option>
                                <option value="21:30">9:30 PM</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label>&nbsp;</label>
                            <button id="checkBtn" class="btn btn-primary form-control">Check</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h4 class="mb-0">Available Tables</h4>
                </div>
                <div class="card-body text-center" id="tablesContainer">
                    <p>Please select a date and time to view available tables.</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Wait until DOM is fully loaded
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded - floor plan script running');
        
        // Get references to DOM elements
        const checkBtn = document.getElementById('checkBtn');
        const dateInput = document.getElementById('date');
        const timeInput = document.getElementById('time');
        const tablesContainer = document.getElementById('tablesContainer');
        
        console.log('Check button:', checkBtn);
        
        // Add event listener to the check button
        checkBtn.addEventListener('click', function() {
            console.log('Check button clicked');
            
            // Get selected date and time
            const date = dateInput.value;
            const time = timeInput.value;
            
            console.log('Selected date:', date);
            console.log('Selected time:', time);
            
            if (!date || !time) {
                alert('Please select both date and time');
                return;
            }
            
            // Show loading message
            tablesContainer.innerHTML = '<p class="text-center">Loading tables...</p>';
            
            // Fetch table data from API
            console.log(`Fetching from: /api/table-availability/?date=${date}&time=${time}`);
            
            fetch(`/api/table-availability/?date=${date}&time=${time}`)
                .then(response => {
                    console.log('Response status:', response.status);
                    if (!response.ok) {
                        return response.text().then(text => {
                            console.error('Error response:', text);
                            throw new Error(`Server responded with status: ${response.status}`);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('API response:', data);
                    
                    if (!data.tables || data.tables.length === 0) {
                        tablesContainer.innerHTML = '<p class="text-center">No tables found for the selected date and time.</p>';
                        return;
                    }
                    
                    displayTables(data.tables);
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                    tablesContainer.innerHTML = '<p class="text-center text-danger">Error loading tables. Please try again.</p>';
                    
                    // Fallback to demo data
                    console.log('Using fallback demo data');
                    const demoTables = [
                        {id: 1, number: 1, capacity: 2, available: true},
                        {id: 2, number: 2, capacity: 4, available: false},
                        {id: 3, number: 3, capacity: 2, available: true},
                        {id: 4, number: 4, capacity: 6, available: true},
                        {id: 5, number: 5, capacity: 4, available: false},
                        {id: 6, number: 6, capacity: 2, available: true}
                    ];
                    
                    displayTables(demoTables);
                });
        });
        
        function displayTables(tables) {
            // Clear tables container
            tablesContainer.innerHTML = '';
            
            // Create container for table cards
            const tableGrid = document.createElement('div');
            tableGrid.className = 'row g-3';
            
            // Create and append table cards
            tables.forEach(function(table) {
                // Create column and card
                const col = document.createElement('div');
                col.className = 'col-md-4 col-sm-6 mb-3';
                
                // Create seat indicators based on capacity
                let seatIcons = '';
                for (let i = 0; i < table.capacity; i++) {
                    seatIcons += '<span class="seat-icon">ðŸ‘¤</span> ';
                }
                
                // Create card HTML
                col.innerHTML = `
                    <div class="card ${table.available ? 'border-success' : 'border-danger'}">
                        <div class="card-header ${table.available ? 'bg-success' : 'bg-danger'} text-white">
                            <h5 class="card-title mb-0">Table ${table.number}</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-2">
                                ${seatIcons}
                            </div>
                            <p class="card-text">
                                <strong>Capacity:</strong> ${table.capacity} people<br>
                                <strong>Status:</strong> 
                                <span class="badge ${table.available ? 'bg-success' : 'bg-danger'}">
                                    ${table.available ? 'Available' : 'Booked'}
                                </span>
                            </p>
                            ${table.available ? 
                              `<a href="/make-booking/?table_id=${table.id}&date=${dateInput.value}&time=${timeInput.value}" 
                                 class="btn btn-primary w-100">Book Now</a>` : ''}
                        </div>
                    </div>
                `;
                
                // Add to grid
                tableGrid.appendChild(col);
            });
            
            // Add table grid to container
            tablesContainer.appendChild(tableGrid);
            
            console.log('Tables displayed:', tables.length);
        }
    });
</script>

<style>
    /* Add any custom styles needed */
    .card {
        transition: transform 0.2s;
        margin-bottom: 20px;
    }
    .card:hover {
        transform: translateY(-5px);
    }
    .seat-icon {
        margin: 0 2px;
        font-size: 1.2em;
    }
    /* For browsers that don't support emoji */
    .seat-icon:before {
        content: "ðŸ‘¤";
    }
</style>
{% endblock %}
